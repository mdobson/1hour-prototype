<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>Test</title>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.css" />
  <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
  <script src="apigee.js"></script>
  <script>
    var apigee = new Apigee.Client({
      orgName:"mdobson",
      appName:"sandbox",
      logging: true
    });

    var landmarks = null;

    function queryLandmarks(loc) {
      var lat = loc.coords.latitude;
      var lon = loc.coords.longitude;

      var staticMapLink = "http://maps.googleapis.com/maps/api/staticmap?center="+lat+","+lon+"&zoom=15&size=400x200&sensor=false";

      var query = "where location within 1500 of "+ lat + "," + lon;

      var options = {
        type:"landmarks",
        client:apigee,
        qs: {
          ql: query
        }
      };

      landmarks = new Apigee.Collection(options);
      landmarks.fetch(function(error, result) {
        if(error) {
          alert("We've had an error!");
        } else {
          $("#landmarks").empty();
          appendLandmarks();
          $("#landmarks").listview("refresh");
          //$("#map").attr("src", staticMapLink);
        }
      });

    }

    function appendLandmarks() {
      //var tag = 1;
      while(landmarks.hasNextEntity()) {
        var landmark = landmarks.getNextEntity();
        var name = landmark.get("resource");
        var city = landmark.get("city");
        var landmarkLocation = landmark.get("location");

        var template = "<li><h4>"+name+"</h4><p>"+city+"</p></li>";
        //staticMapLink += "&markers=color:blue%7Clabel:"+tag+"%7C"+landmarkLocation.latitude+","+landmarkLocation.longitude;
        $("#landmarks").append(template);
        //tag++;
      }
    }

    function addNewLocation(loc) {
      var lat = loc.coords.latitude;
      var lon = loc.coords.longitude;

      var name = $("#name").val();
      var city = $("#city").val();

      var options = {
        type: "landmarks",
        resource: name,
        city: city,
        location: {
          latitude:lat,
          longitude: lon
        }
      };

      apigee.createEntity(options, function(error, results) {
        if(error) {
          alert("There was an error!");
        } else {
          queryLandmarks(loc);
          history.back();
        }
      });
    }

    $(document).ready(function(){
      navigator.geolocation.getCurrentPosition(queryLandmarks);
      $("#submit").live("click", function() {
        navigator.geolocation.getCurrentPosition(addNewLocation);
      });
      $("#more").live("click", function(){
        landmarks.getNextPage(function(error, response){
          if(error) {
            console.log("There was an error");
          } else {
            appendLandmarks();
            $("#landmarks").listview("refresh");
          }
        });
      });
    });
  </script>
  <body>
    <div data-role="page">
      <div data-role="header">
        <h3>
          Historical Landmarks!
        </h3>
        <a href="#addLandmark" data-role="button" class="ui-btn-right" data-rel="dialog" data-icon="pos">Add</a>
      </div>
      <div data-role="content">
        <!-- <img height="200" width="400" id="map"/> -->
        <ul data-role="listview" id="landmarks">
          <li>
            <h3>Landmark 1</h3>
            <p>Location 1</p>
          </li>
        </ul>
        <button id="more">More Results</button>
      </div>
    </div>
    <div data-role="page" id="addLandmark">
      <div data-role="header">
        <h3>
          Details
        <h3>
      </div>
      <div data-role="content">
        <label for="name">Name:</label>
        <textarea id="name"></textarea>
        <label for="city">City:</label>
        <textarea id="city"></textarea>
        <button id="submit">Submit</button>
      </div>
    </div>


  </body>
</html>
